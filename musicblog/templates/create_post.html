{% extends "layout.html" %}
{% block content %}
<div class="content-section">
   <form action="" novalidate method="POST">
        {{ form.hidden_tag() }}
        <fieldset class="form-group">
            <legend class="border-bottom mb-4"><strong>New Post</strong></legend>
            
            <!-- Title -->
            <div class="form-group">
                {{ form.title.label(class="form-control-label") }}

                {% if form.title.errors %}
                    {{ form.title(class="form-control form-control-lg mb-2 is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.title.errors %}
                            <span>{{ error}} </span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.title(class="form-control form-control-lg mb-2") }}
                {% endif %}
            </div>

            <!-- Album Search -->
            <div class="form-group">
                <label for="album-search" class="form-control-label">Album</label>
                <input type="text" id="album-search" class="form-control mb-2" placeholder="Search for an album...">
                <ul id="album-results" class="list-group"></ul>
            </div>

            <!-- Album Preview -->
            <div id="album-preview" class="my-3"></div>

            <!-- Hidden fields to capture album data -->
            {{ form.album_name }}
            {{ form.album_artist }}
            {{ form.album_image }}

            <!-- Content -->
            <div class="form-group">
                {{ form.content.label(class="form-control-label") }}

                {% if form.content.errors %}
                    {{ form.content(class="form-control form-control-lg mb-2 is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.content.errors %}
                            <span>{{ error}} </span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.content(class="form-control form-control-lg mb-2") }}
                {% endif %}
            </div>
        </fieldset>

        <!-- Submit -->
        <div class="form-group pt-3 mb-2">
            {{ form.submit(class="btn btn-outline-info") }}
        </div>
   </form>
</div>

<!-- Album search JavaScript -->

<script>
const albumSearch = document.getElementById("album-search");
const resultsList = document.getElementById("album-results");

albumSearch.addEventListener("input", async function(e) {
  const q = e.target.value.trim();
  if (q.length < 2) {
    resultsList.innerHTML = "";
    resultsList.style.display = "none";
    return;
  }

  const res = await fetch(`/search_album?q=${encodeURIComponent(q)}`);
  const data = await res.json();

  const results = data.albums.items || [];
  if (results.length === 0) {
    resultsList.innerHTML = "";
    resultsList.style.display = "none";
    return;
  }

  resultsList.innerHTML = "";
  resultsList.style.display = "block"; // show the dropdown

  results.forEach(album => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action d-flex align-items-center";
    li.style.cursor = "pointer";
    li.innerHTML = `<img src="${album.images[2]?.url}" width="50" class="me-2"> 
                    ${album.name} — ${album.artists[0].name}`;

    li.addEventListener("click", () => {
      // Show album preview
      document.getElementById("album-preview").innerHTML =
        `<img src="${album.images[0]?.url}" class="img-fluid mb-2">
         <p><strong>${album.name}</strong> — ${album.artists[0].name}</p>`;

      // Fill hidden form fields
      document.getElementById("album_name").value = album.name;
      document.getElementById("album_artist").value = album.artists[0].name;
      document.getElementById("album_image").value = album.images[0]?.url;

      // Update search input
      albumSearch.value = `${album.name} — ${album.artists[0].name}`;

      // Hide the dropdown completely
      resultsList.innerHTML = "";
      resultsList.style.display = "none";
    });

    resultsList.appendChild(li);
  });
});

// Hide dropdown if user clicks outside
document.addEventListener("click", function(e) {
  if (!albumSearch.contains(e.target) && !resultsList.contains(e.target)) {
    resultsList.style.display = "none";
  }
});
</script>

{% endblock content %}
